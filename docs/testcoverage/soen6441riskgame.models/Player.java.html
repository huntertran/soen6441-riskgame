<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Player.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">soen6441riskgame</a> &gt; <a href="index.source.html" class="el_package">soen6441riskgame.models</a> &gt; <span class="el_source">Player.java</span></div><h1>Player.java</h1><pre class="source lang-java linenums">package soen6441riskgame.models;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.Observable;

import com.google.gson.annotations.Expose;
import com.google.gson.annotations.JsonAdapter;

import soen6441riskgame.enums.ChangedProperty;
import soen6441riskgame.enums.GamePhase;
import soen6441riskgame.models.serializers.NameOnlyJsonAdapter;
import soen6441riskgame.models.serializers.NameOnlySerializable;
import soen6441riskgame.singleton.GameBoard;
import soen6441riskgame.utils.ConsolePrinter;

/**
 * Hold player data
 *
 * Each player is a node in a linked list
 */
public class Player extends Observable implements NameOnlySerializable {
    private static final int MAX_NUMBER_OF_CARD_TO_FORCE_EXCHANGE = 5;
    private static final int LEAST_NUMBER_OF_ARMIES_INIT_IN_TURN = 3;
    private static final int INIT_ARMY_DIVIDE_FRACTION = 3;

    @Expose
    private String name;

    @Expose
    private int unplacedArmies;

<span class="fc" id="L33">    @Expose</span>
    private boolean isPlaying = false;

    @JsonAdapter(NameOnlyJsonAdapter.class)
    @Expose
    private Player nextPlayer;

    @JsonAdapter(NameOnlyJsonAdapter.class)
    @Expose
    private Player previousPlayer;

    @Expose
    private GamePhase currentPhase;

<span class="fc" id="L47">    private ArrayList&lt;Card&gt; holdingCards = new ArrayList&lt;Card&gt;();</span>

<span class="fc" id="L49">    @Expose</span>
    private ArrayList&lt;String&gt; currentPhaseActions = new ArrayList&lt;String&gt;();

<span class="fc" id="L52">    @Expose</span>
    private boolean isPlayerBeAwardCard = false;

    /**
     * constructor
     *
     * @param name player's name
     */
<span class="fc" id="L60">    public Player(String name) {</span>
<span class="fc" id="L61">        this.name = name;</span>
<span class="fc" id="L62">        this.currentPhase = GamePhase.WAITING_TO_TURN;</span>
<span class="fc" id="L63">    }</span>

    /**
     * check if this player have conquered at least 1 country in the attack phase, therefore, be award a
     * card from deck
     *
     * @return is player be award card
     */
    public boolean isPlayerBeAwardCard() {
<span class="fc" id="L72">        return isPlayerBeAwardCard;</span>
    }

    /**
     * mark this player have conquered at least 1 country in the attack phase, therefore, be award a
     * card from deck
     *
     * @param isPlayerAwardCard set the mark
     */
    public void setPlayerBeAwardCard(boolean isPlayerAwardCard) {
<span class="nc" id="L82">        this.isPlayerBeAwardCard = isPlayerAwardCard;</span>
<span class="nc" id="L83">    }</span>

    /**
     * get player's current phase
     *
     * @return game phase of the player
     */
    public GamePhase getCurrentPhase() {
<span class="fc" id="L91">        return currentPhase;</span>
    }

    /**
     * set player's current phase
     *
     * @param newPhase the phase to set
     */
    public void setCurrentPhase(GamePhase newPhase) {
<span class="fc bfc" id="L100" title="All 2 branches covered.">        if (currentPhase != newPhase) {</span>

<span class="fc" id="L102">            boolean isChangePhaseAllowed = true;</span>

<span class="pc bpc" id="L104" title="1 of 2 branches missed.">            if ((newPhase.getGamePhaseAsInt() - currentPhase.getGamePhaseAsInt()) != 1) {</span>
<span class="nc" id="L105">                isChangePhaseAllowed = false;</span>

<span class="nc bnc" id="L107" title="All 4 branches missed.">                if (newPhase != GamePhase.WAITING_TO_TURN</span>
                    || currentPhase != GamePhase.FORTIFICATION) {
<span class="nc" id="L109">                    isChangePhaseAllowed = false;</span>
                } else {
<span class="nc" id="L111">                    isChangePhaseAllowed = true;</span>
                }
            }

<span class="fc bfc" id="L115" title="All 2 branches covered.">            if (newPhase == GamePhase.ATTACK) {</span>
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">                if (holdingCards.size() &gt;= MAX_NUMBER_OF_CARD_TO_FORCE_EXCHANGE) {</span>
<span class="nc" id="L117">                    ConsolePrinter.printFormat(&quot;You have more than %d cards. Must exchange before attacking.&quot;,</span>
<span class="nc" id="L118">                                               MAX_NUMBER_OF_CARD_TO_FORCE_EXCHANGE);</span>

<span class="nc" id="L120">                    isChangePhaseAllowed = false;</span>
                }
            }

<span class="pc bpc" id="L124" title="1 of 2 branches missed.">            if (isChangePhaseAllowed) {</span>
<span class="fc" id="L125">                currentPhase = newPhase;</span>
<span class="fc" id="L126">                currentPhaseActions.clear();</span>
<span class="fc" id="L127">                setChanged();</span>
<span class="fc" id="L128">                notifyObservers(ChangedProperty.GAME_PHASE);</span>

<span class="fc bfc" id="L130" title="All 2 branches covered.">                if (newPhase == GamePhase.REINFORCEMENT) {</span>
<span class="fc" id="L131">                    this.addObserver(GameBoard.getInstance().getExchangeCardView());</span>
                } else {
<span class="fc" id="L133">                    this.deleteObserver(GameBoard.getInstance().getExchangeCardView());</span>
                }

<span class="fc bfc" id="L136" title="All 2 branches covered.">                if (newPhase == GamePhase.FORTIFICATION) {</span>
<span class="fc" id="L137">                    getACardFromDeck();</span>
                }
            } else {
<span class="nc" id="L140">                ConsolePrinter.printFormat(&quot;Player %s cannot change from phase %s to phase %s&quot;,</span>
<span class="nc" id="L141">                                           getName(),</span>
<span class="nc" id="L142">                                           currentPhase.toString(),</span>
<span class="nc" id="L143">                                           newPhase.toString());</span>
            }
        }
<span class="fc" id="L146">    }</span>

    /**
     * add new card if player conquer at least 1 country during attack phase
     */
    public void getACardFromDeck() {
<span class="pc bpc" id="L152" title="1 of 2 branches missed.">        if (isPlayerBeAwardCard()) {</span>
<span class="nc" id="L153">            Card newCard = GameBoard.getInstance().getRandomAvailableCard();</span>
<span class="nc" id="L154">            newCard.setHoldingPlayer(this);</span>
<span class="nc" id="L155">            holdingCards.add(newCard);</span>
<span class="nc" id="L156">            setPlayerBeAwardCard(false);</span>
<span class="nc" id="L157">            setChanged();</span>
<span class="nc" id="L158">            notifyObservers(ChangedProperty.CARD);</span>
        }
<span class="fc" id="L160">    }</span>

    /**
     * get player's list of cards
     *
     * @return player's list of cards
     */
    public ArrayList&lt;Card&gt; getHoldingCards() {
<span class="fc" id="L168">        return holdingCards;</span>
    }

    /**
     * get the player's card in specific position
     *
     * @param position start with 1
     * @return null if position not exist
     */
    public Card getHoldingCard(int position) {
<span class="pc bpc" id="L178" title="2 of 4 branches missed.">        if (position &gt; holdingCards.size() || position &lt;= 0) {</span>
<span class="nc" id="L179">            ConsolePrinter.printFormat(&quot;You only have %d card&quot;, holdingCards.size());</span>
<span class="nc" id="L180">            return null;</span>
        } else {
<span class="fc" id="L182">            return holdingCards.get(position - 1);</span>
        }
    }

    /**
     * return all the exchanged cards that player is holding
     */
    public void removeExchangedCards() {
<span class="fc bfc" id="L190" title="All 2 branches covered.">        for (Iterator&lt;Card&gt; cardList = holdingCards.listIterator(); cardList.hasNext();) {</span>
<span class="fc" id="L191">            Card card = cardList.next();</span>
<span class="pc bpc" id="L192" title="1 of 2 branches missed.">            if (card.isExchanged()) {</span>
<span class="fc" id="L193">                card.setExchanged(false);</span>
<span class="fc" id="L194">                card.setHoldingPlayer(null);</span>
<span class="fc" id="L195">                cardList.remove();</span>
            }
<span class="fc" id="L197">        }</span>
<span class="fc" id="L198">    }</span>

    /**
     * get the list of action for current phase
     *
     * @return list of action for current phase
     */
    public ArrayList&lt;String&gt; getCurrentPhaseActions() {
<span class="fc" id="L206">        return currentPhaseActions;</span>
    }

    /**
     * add new action for current phase
     *
     * @param action the action string
     */
    public void addCurrentPhaseAction(String action) {
<span class="fc" id="L215">        currentPhaseActions.add(action);</span>
<span class="fc" id="L216">        setChanged();</span>
<span class="fc" id="L217">        notifyObservers(ChangedProperty.GAME_PHASE);</span>
<span class="fc" id="L218">    }</span>

    /**
     * get previous player on the linked list
     *
     * @return previous player
     */
    public Player getPreviousPlayer() {
<span class="fc" id="L226">        return previousPlayer;</span>
    }

    /**
     * set previous player
     *
     * @param previousPlayer the player object
     */
    public void setPreviousPlayer(Player previousPlayer) {
<span class="fc" id="L235">        this.previousPlayer = previousPlayer;</span>

<span class="fc bfc" id="L237" title="All 2 branches covered.">        if (previousPlayer.getNextPlayer() != this) {</span>
<span class="fc" id="L238">            previousPlayer.setNextPlayer(this);</span>
        }
<span class="fc" id="L240">    }</span>

    /**
     * get next player on the linked list
     *
     * @return next player on the linked list
     */
    public Player getNextPlayer() {
<span class="fc" id="L248">        return nextPlayer;</span>
    }

    /**
     * set next player
     *
     * @param nextPlayer the player object
     */
    public void setNextPlayer(Player nextPlayer) {
<span class="fc" id="L257">        this.nextPlayer = nextPlayer;</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">        if (nextPlayer.getPreviousPlayer() != this) {</span>
<span class="fc" id="L259">            nextPlayer.setPreviousPlayer(this);</span>
        }
<span class="fc" id="L261">    }</span>

    /**
     * get player name
     *
     * @return player name
     */
    public String getName() {
<span class="fc" id="L269">        return name;</span>
    }

    /**
     * get total armies a player have
     *
     * @return total armies
     */
    public int getTotalArmies() {
<span class="fc" id="L278">        int totalArmies = 0;</span>

<span class="fc" id="L280">        ArrayList&lt;Country&gt; conqueredCountries = getConqueredCountries();</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">        for (Country country : conqueredCountries) {</span>
<span class="fc" id="L282">            totalArmies += country.getArmyAmount();</span>
<span class="fc" id="L283">        }</span>

<span class="fc" id="L285">        totalArmies += getUnplacedArmies();</span>

<span class="fc" id="L287">        return totalArmies;</span>
    }

    /**
     * get a list of conquered continents of this player
     *
     * @return list of conquered continents
     */
    public ArrayList&lt;Continent&gt; getConqueredContinents() {
<span class="fc" id="L296">        ArrayList&lt;Continent&gt; conquered = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L298" title="All 2 branches covered.">        for (Continent continent : GameBoard.getInstance().getGameBoardMap().getContinents()) {</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">            if (continent != null) {</span>
<span class="fc bfc" id="L300" title="All 2 branches covered.">                if (this.equals(continent.getConquerer())) {</span>
<span class="fc" id="L301">                    conquered.add(continent);</span>
                }
            }
<span class="fc" id="L304">        }</span>

<span class="fc" id="L306">        return conquered;</span>
    }

    /**
     * get all the conquered country of this player
     *
     * @return empty list if no country
     */
    public ArrayList&lt;Country&gt; getConqueredCountries() {
<span class="fc" id="L315">        ArrayList&lt;Country&gt; conquered = new ArrayList&lt;&gt;();</span>

<span class="fc bfc" id="L317" title="All 2 branches covered.">        for (Country country : GameBoard.getInstance().getGameBoardMap().getCountries()) {</span>
<span class="pc bpc" id="L318" title="1 of 2 branches missed.">            if (country != null) {</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">                if (this.equals(country.getConquerer())) {</span>
<span class="fc" id="L320">                    conquered.add(country);</span>
                }
            }
<span class="fc" id="L323">        }</span>

<span class="fc" id="L325">        return conquered;</span>
    }

    /**
     * check if this player is still in the game
     *
     * @return is this player is still in the game
     */
    public boolean isPlaying() {
<span class="fc" id="L334">        return isPlaying;</span>
    }

    /**
     * set is this player is till in the game
     *
     * @param isPlaying is this player is till in the game
     */
    public void setPlaying(boolean isPlaying) {
<span class="fc" id="L343">        this.isPlaying = isPlaying;</span>
<span class="fc" id="L344">    }</span>

    /**
     * get player unplaced armies
     *
     * @return player unplaced armies
     */
    public int getUnplacedArmies() {
<span class="fc" id="L352">        return unplacedArmies;</span>
    }

    /**
     * set player unplaced armies
     *
     * @param unplacedArmies the number of armies
     */
    public void setUnplacedArmies(int unplacedArmies) {
<span class="fc" id="L361">        this.unplacedArmies = unplacedArmies;</span>
<span class="fc" id="L362">    }</span>

    /**
     * REINFORCEMENT PHASE get the number of armies player will get for reinforcement phase for all the
     * country player have.
     *
     * @return the number of armies. Minimum number of armies are #{@value #INIT_ARMY_DIVIDE_FRACTION}
     */
    private int getArmiesFromAllConqueredCountries() {
<span class="fc" id="L371">        ArrayList&lt;Country&gt; conqueredCountries = getConqueredCountries();</span>
<span class="fc" id="L372">        return Math.round(conqueredCountries.size() / INIT_ARMY_DIVIDE_FRACTION);</span>
    }

    /**
     * REINFORCEMENT PHASE get the number of armies player will have for the conquered continent
     *
     * @return the number of armies. 0 if user don't own any continent.
     */
    private int getArmiesFromConqueredContinents() {
<span class="fc" id="L381">        int armiesFromConqueredContinents = 0;</span>

<span class="fc bfc" id="L383" title="All 2 branches covered.">        for (Continent continent : GameBoard.getInstance().getGameBoardMap().getContinents()) {</span>
<span class="fc bfc" id="L384" title="All 2 branches covered.">            if (this.equals(continent.getConquerer())) {</span>
<span class="fc" id="L385">                armiesFromConqueredContinents = armiesFromConqueredContinents + continent.getArmy();</span>
            }
<span class="fc" id="L387">        }</span>

<span class="fc" id="L389">        return armiesFromConqueredContinents;</span>
    }

    /**
     * REINFORCEMENT PHASE calculate the number of armies a player will have for his reinforcement phase
     */
    public void calculateReinforcementArmies() {
<span class="fc bfc" id="L396" title="All 2 branches covered.">        if (this.getCurrentPhase() != GamePhase.REINFORCEMENT) {</span>
<span class="fc" id="L397">            ConsolePrinter.printFormat(&quot;Cannot get new army for player %s on $%s phase&quot;,</span>
<span class="fc" id="L398">                                       this.getName(),</span>
<span class="fc" id="L399">                                       this.getCurrentPhase().toString());</span>
<span class="fc" id="L400">            return;</span>
        }

<span class="fc" id="L403">        int armiesFromAllConqueredCountries = getArmiesFromAllConqueredCountries();</span>
<span class="fc" id="L404">        int armiesFromConqueredContinents = getArmiesFromConqueredContinents();</span>

<span class="pc bpc" id="L406" title="1 of 2 branches missed.">        if (armiesFromAllConqueredCountries &lt; LEAST_NUMBER_OF_ARMIES_INIT_IN_TURN) {</span>
<span class="nc" id="L407">            armiesFromAllConqueredCountries = LEAST_NUMBER_OF_ARMIES_INIT_IN_TURN;</span>
        }

<span class="fc" id="L410">        int newUnplacedArmies = getUnplacedArmies() + armiesFromAllConqueredCountries + armiesFromConqueredContinents;</span>
<span class="fc" id="L411">        setUnplacedArmies(newUnplacedArmies);</span>
<span class="fc" id="L412">    }</span>

    /**
     * do the reinforcement
     *
     * @param country        country to reinforce
     * @param numberOfArmies armies to reinforce
     */
    public void reinforce(Country country, int numberOfArmies) {
<span class="fc bfc" id="L421" title="All 2 branches covered.">        if (!country.isCountryBelongToPlayer(this)) {</span>
<span class="fc" id="L422">            return;</span>
        }

<span class="pc bpc" id="L425" title="1 of 2 branches missed.">        if (this.getUnplacedArmies() != 0) {</span>
<span class="fc" id="L426">            country.receiveArmiesFromUnPlacedArmies(numberOfArmies);</span>
<span class="fc" id="L427">            this.addCurrentPhaseAction(&quot;Reinforce: &quot; + country.getName() + &quot; with &quot; + numberOfArmies);</span>
        }

<span class="fc bfc" id="L430" title="All 2 branches covered.">        if (this.getUnplacedArmies() == 0) {</span>
<span class="fc" id="L431">            ConsolePrinter.printFormat(&quot;Player %s enter ATTACK phase&quot;, this.getName());</span>
<span class="fc" id="L432">            this.setCurrentPhase(GamePhase.ATTACK);</span>
        }
<span class="fc" id="L434">    }</span>

    /**
     * do the fortify
     *
     * @param fromCountry    from country
     * @param toCountry      to country
     * @param numberOfArmies armies to fortify
     */
    public void fortify(Country fromCountry, Country toCountry, int numberOfArmies) {
<span class="fc" id="L444">        fromCountry.moveArmies(toCountry, numberOfArmies);</span>
<span class="fc" id="L445">        this.addCurrentPhaseAction(&quot;Fortify: from &quot;</span>
<span class="fc" id="L446">                                   + fromCountry.getName()</span>
                                   + &quot; to &quot;
<span class="fc" id="L448">                                   + toCountry.getName()</span>
                                   + &quot; with &quot;
<span class="fc" id="L450">                                   + String.valueOf(numberOfArmies)</span>
                                   + &quot; armies&quot;);
<span class="fc" id="L452">    }</span>

    @Override
    public String getPropertyName() {
<span class="fc" id="L456">        return &quot;name&quot;;</span>
    }

    @Override
    public String getPropertyValue() {
<span class="pc bpc" id="L461" title="2 of 4 branches missed.">        if (name == null || name.isEmpty()) {</span>
<span class="nc" id="L462">            return &quot;&quot;;</span>
        }

<span class="fc" id="L465">        return name;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.1.201803210924</span></div></body></html>